services:
  db:
    extends:
      file: docker-compose.yml
      service: db
    ports:
      - ${DB_PORT}:5432

  mail:
    extends:
      file: docker-compose.yml
      service: mail
    ports:
      - ${MAIL_PORT}:1080

  app:
    extends:
      file: docker-compose.yml
      service: app
    env_file:
      - .env
      - .env.test

  api_app:
    extends:
      file: docker-compose.yml
      service: api_app
    env_file:
      - .env
      - .env.test

  webhook_app:
    extends:
      file: docker-compose.yml
      service: webhook_app
    env_file:
      - .env
      - .env.test

  cron_app:
    extends:
      file: docker-compose.yml
      service: cron_app
    env_file:
      - .env
      - .env.test

  minio:
    extends:
      file: docker-compose.yml
      service: minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    env_file:
      - .env
      - .env.test

  # MinIO client to initialize buckets
  minio_client:
    extends:
      file: docker-compose.yml
      service: minio_client
    environment:
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-http://minio:9000}
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-uploads}
    env_file:
      - .env
      - .env.test

  frontend:
    extends:
      file: docker-compose.yml
      service: frontend
    env_file:
      - ./apps/frontend/.env
      - ./apps/frontend/.env.test

  app_router:
    extends:
      file: docker-compose.yml
      service: app_router
    environment:
      LEGACY_APP_COOKIE_DOMAIN: ${BEABEE_COOKIE_DOMAIN}
      TRUSTED_ORIGINS: ${BEABEE_TRUSTEDORIGINS-}
    ports:
      - ${ROUTER_PORT}:80

  migration:
    extends:
      file: docker-compose.yml
      service: migration
    env_file:
      - .env
      - .env.test

  stripe_cli:
    extends:
      file: docker-compose.yml
      service: stripe_cli
    environment:
      - STRIPE_API_KEY=${BEABEE_STRIPE_SECRETKEY}
      - STRIPE_DEVICE_NAME=beabee-test-docker-container

volumes:
  db_data:
  upload_data:
  minio_data:
